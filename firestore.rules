rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =================================================================
    // Security Rules for Frete7 Connector
    // =================================================================

    // Users Collection:
    // 1. Read: Any authenticated user can read any user profile.
    // 2. Create: Anyone can create a new user document (for sign-ups).
    // 3. Update: A user can only update their own document. Admins can update any.
    // 4. Delete: Only admins can delete user documents.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if true;
      allow update: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Freights Collection:
    // 1. Read: Only admins can read the full list of freights.
    // 2. Get: (Future rule) Authenticated companies/drivers might be able to get specific freight details.
    // 3. Create: Anyone (including unauthenticated users) can create a new freight request.
    // 4. Update/Delete: Only admins can modify or delete freights.
    match /freights/{freightId} {
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow get: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow create: if true;
      allow update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Vehicle Related Collections (vehicle_types, vehicle_categories, vehicles, body_types):
    // 1. Read: Any authenticated user can read these lists (needed for forms, etc.).
    // 2. Create, Update, Delete: Only admins can manage these core data collections.
    match /{collection}/{docId} where collection in ['vehicle_types', 'vehicle_categories', 'vehicles', 'body_types'] {
      allow read: if request.auth != null;
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Plans Collection:
    // 1. Read: Any authenticated user can read the list of plans.
    // 2. Write (Create, Update, Delete): Only admins can manage plans.
    match /plans/{planId} {
        allow read: if request.auth != null;
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
